##### NAT

**出现的背景：**  
联网的设备越来越多，为了安全企业都开始构建自己的专用网，专用网只有一台路由器连接公网，其他所有设备都只在内网工作，这样缓解了 IP 地址资源日益缺少的问题。但是当内部的主机需要访问外网的时候，因为专用网中的所有设备分配的都是专用网中的 IP 地址，而不是公网地址，所以根本无法访问外部网络，但是总有必须访问外网的时候。为了解决这个问题，而又不浪费 IP 地址，于是出现了 NAT （网络地址转换），为需要访问外网的设备分配一个公网的 IP 地址，于是这个设备就可以访问公网了。

网络地址转换可以隐藏专用网中的主机，有一定的安全作用。

**NAT 原理：**  
NAT 是将网络地址从一个内部私有 IP 地址转换为合法 IP 地址的行为。NAT 会将数据包中的 IP 包头改变，将其中的目的地址、源地址或者两个地址都替换成公网地址。NAT 协议将网络分为内部网络 inside 和外部网络 outside 。当内部的数据包发往公网，或外网的数据包发向内网时，就将数据包中的包头更改，达到内网与公网正常通信的效果。

![](https://data.educoder.net/api/attachments/1132193)

NAT 在使用过程种出现一些不可避免的问题：

1.  最初 IP 地址被设计出来就是为每一个设备都分配一个 IP 地址，标识了一个网络的连接，然而 NAT 的出现刚好违反这最初的想法。NAT 使得很多主机可能在使用相同的 IP 地址。
    
2.  NAT 使得 IP 协议从面向无连接变成了面向连接。NAT 必须维护换用 IP 地址与公用 IP 地址以及端口号之间的映射关系。在 TCP/IP 协议体系中，如果一个路由器出现故障，不会影响 TCP 协议的执行，因为只要几秒收不到应答，发送进程就会进入超时重传处理。而当存在 NAT 时，最初设计的 TCP/IP 协议的处理过程将会发生变化，Internet 可能会变得非常脆弱。
    
3.  NAT 违反了基本的网络分层结构模型的设计原则。因为在传统的网络分层结构模型中，第 N 层是不能修改第 N+1 层的报头内容的。子网内的主机需要和外网进行通信时，路由器将 IP 首部中的 IP 地址进行替换（替换成 WAN 口 IP ），这样逐级替换，最终数据包中的 IP 地址将变成为一个公网 IP 。NAT 破坏了这种各层之间的独立性。
    
4.  NAT 存在对高层协议和安全性的影响问题。NAT 只是临时性缓解了 IP 地址短缺的暂时方案，并不是解决问题的根本办法，而根本办法是向 IPv6 迁移。
    

**静态 NAT ：**  
如果一个内部主机唯一占用一个公网 IP ，这种方式被称为一对一模型。此种方式下，转换上层协议就是不必要的，因为一个公网 IP 就能唯一对应一个内部主机。显然，这种方式对节约公网 IP 没有太大意义，主要是为了实现一些特殊的组网需求。比如**用户希望隐藏内部主机的真实 IP ，或者实现两个 IP 地址重叠网络的通信**。

**限制：**

1.影响网络速度，NAT 的应用会使 NAT 设备变成网络的瓶颈；  
2.跟某些应用不兼容，如果一些应用在有效载荷中协商下次会话的 IP 地址和端口号，NAT 将无法对内嵌 IP 地址进行地址转换，造成这些程序不能正常运行；  
3.地址转换不能处理 IP 报头加密的报文；  
4.无法实现对 IP 端到端的路径跟踪，经过 NAT 地址转换后，对数据包的路径跟踪变得非常困难。

##### 静态 NAT 配置方法

NAT 在边界路由器上进行配置，连接内部网络的端口是内部接口，连接外部网络的部分是外部接口，在配置的时候**需要进入接口配置指明内部接口与外部接口**。

1.  `R1(config)#int f0/0`  
2.  `R1(config-if)#ip nat inside`  
3.  `//将接口标记为内部接口`  
4.  `R1(config-if)#int s0/0`  
5.  `R1(config-if)#ip nat outside`  
6.  `//将接口标记为外部接口`  

配置静态 NAT 的时候，内部专用网在外网必须有自己的合法公网地址，才能配置静态 NAT 地址转换，而且静态 NAT 地址转换是一个内网地址对应一个外网地址。

NAT 配置命令为：

1.  `ip nat inside(内部） source static（静态） 192.168.1.1（源地址） 100.1.1.1（外部接口IP地址）`   

例：在 R1 上配置静态 NAT ，将 PC1 的 IP 地址 192.168.1.1 映射成公网地址 100.1.1.21

![,](https://data.educoder.net/api/attachments/1132197)

R1

1.  `R1(config)#int f0/0`  
2.  `R1(config-if)#ip nat inside`  
3.  `//将接口设置为内部接口`  
4.  `R1(config-if)#int s1/0`  
5.  `R1(config-if)#ip nat outside`  
6.  `//将接口设置为外部接口`  
7.  `R1(config-if)#exit`  
8.  `R1(config)#ip nat inside source static 192.168.1.1 100.1.1.21`  
9.  `//配置静态 NAT ，指明内部需要连接外网设备的 IP 地址与外部接口 IP 地址`  

静态 NAT 配置完毕之后，是无法使用的，因为内部网络的路由器不知道外部网络的路由表，**当内网中有多个路由器的时候需要在内部路由器上配置前往边界路由器 ASBR 的默认路由**，而且由于外网的设备并不知道内部网络的 IP 地址，所以外网设备只能将数据发送给映射之后的外部地址。

查看 NAT 配置：使用`show ip nat translations`可以查看 NAT 的映射关系。